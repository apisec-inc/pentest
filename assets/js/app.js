$(document).ready(function () {
    $('#btn').click(function () {
        // var seletedText = $(this).text();
        // const map1 = new Map();
        // // make it hidden by default
        // map1.set('Now', 'ONCE');
        // map1.set('Weekly Report', 'Weekly');
        var testStart = Date.now();
        var email = $('#email').val();
        var openAPISpectemp = $('#openAPISpec').val();
        var openAPISpec = openAPISpectemp.replace("getpostman", "postman");
        $("#email").next().hide();
        $("#openAPISpec").next().hide();
        if (openAPISpec == '') {
            $('.invalid-tooltip').show()
            // return false;
        }
        // if (email == '') {
        //   $('#email').validate()
        //   return false;
        // }
        if (IsEmail(email) == false) {
            $('#email').next().show();
            return false;
        }
        $(this).prop('disabled', true);
        $("#testresult").addClass("d-none");
        $("#tdata").empty();
        $("#fp").empty();
        $('.testdomain').text(openAPISpec);
        $("#loadingresult").removeClass("d-none");

        var jsonData = { 'email': email, 'openAPISpec': openAPISpec, 'sourceName': "APIsec EthicalCheck", "sourceURL": "https://www.ethicalcheck.dev/" };

        // var hutk = document.cookie.replace(/(?:(?:^|.*;\s*)hubspotutk\s*\=\s*([^;]*).*$)|^.*$/, "$1");

        var hutk = document.cookie.replace(/(?:(?:^|.*;\s*)hubspotutk\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        var HSData = {
            "submittedAt": testStart,
            "fields": [
                {
                    "objectTypeId": "0-1",
                    "name": "email",
                    "value": email
                },
                {
                    "objectTypeId": "0-1",
                    "name": "api_specification_url",
                    "value": openAPISpec
                }
            ],
            "context": {
                "pageUri": window.location.href,
                "pageName": "Free API Test",
                "ipAddress": "{ip_address}"
            }
        };
        event.preventDefault();

        $.ajax({
            url: 'https://pentest.apisec.ai/api/v1/pentest',
            method: 'POST',
            dataType: 'json',
            headers: {
                "Content-Type": "application/json"
            },
            data: JSON.stringify(jsonData),
            success: function (result) {
                $('#email').val("");
                $('#openAPISpec').val('');
                $('#btn').prop('disabled', false);
                $("#loadingresult").addClass("d-none");
                $("#errorresult2").addClass("d-none");
                $("#displayerrormessage").addClass("d-none");
                $("#errorresult").addClass("d-none");
                $("#Features").removeClass("d-none");
                $("#testresult").removeClass("d-none");
                var testEnd = Date.now();
                var testTime = Math.round((testEnd - testStart) / 1000);
                $('#date-time').text(new Date().toUTCString());
                $('#testTime').text(testTime + 's');
                tilesView();
                $('html, body').animate({
                    scrollTop: $("#Features").offset().top
                }, 1000);

                if (result.errors) {
                    errorDisplay();
                }
                // $('#inforesult').text(result.messages[0].value);
                // $("#inforesult").removeClass("d-none");

                // if (result.data.testSummary.vulnerabilitiesFound >= 1) {
                //   $("#gradeC").removeClass("d-none");
                //   $("#gradeA").addClass("d-none");
                // } else {
                //   $("#gradeA").removeClass("d-none");
                //   $("#gradeC").addClass("d-none");
                // }
                tableDisplay();

                // $("#inforesult").addClass("d-none");
                // ga('send', { 'hitType': 'pageview', 'page': '/api-scan-results', 'title': 'Free API Scan Results' });

                function tableDisplay() {
                    if (result.data.testSummary.vulnerabilities.data && result.data.testSummary.vulnerabilities.data.length > 0) {
                        $.each(result.data.testSummary.vulnerabilities.data, function (k, v) {
                            tableresults(v);
                        });
                    }
                    if (result.data.testSummary.testSuiteSummary.data && result.data.testSummary.testSuiteSummary.data.length > 0) {
                        $.each(result.data.testSummary.testSuiteSummary.data, function (i, j) {
                            falsepositvite(j);
                        });
                    }
                }
                function tilesView() {
                    $('#totalTestsExecuted').text(result.data.testSummary.totalEndpoints);
                    $('#host').text(result.data.testSummary.testEnvironment);
                    $('#testsPassed').text(result.data.testSummary.testsPassed);
                    $('#testsFailed').text(result.data.testSummary.testsFailed);
                    $('#vulnerabilitiesFound').text(result.data.testSummary.vulnerabilitiesFound);
                    $('#totalPlaybooks').text(result.data.testSummary.totalPlaybooks);
                    $('#host').text(result.data.testSummary.testEnvironment);
                    $('#falsepostive').text(result.data.testSummary.testSuiteSummary.data.length);
                }
                function errorDisplay() {
                    if (result.messages[0].key === 'Missing Base URL') {
                        $("#displayerrormessage").removeClass("d-none");
                        $("#errorresult").addClass("d-none");
                        $("#testresult").addClass("d-none");
                        // $("#inforesult").addClass("d-none");
                    }
                    else {
                        $("#errorresult").removeClass("d-none");
                        $("#displayerrormessage").addClass("d-none");
                        $("#testresult").addClass("d-none");
                        // $("#inforesult").addClass("d-none");
                        // $('#errorTitle').text(result.messages[0].key);
                        // $('#errorBody1').html('<p>Invalid OpenAPI Specification URL/File, a valid url looks like <a href=" http://netbanking.apisec.ai:8080/v2/api-docs" target="_blank">http://netbanking.apisec.ai:8080/v2/api-docs</a><br/> Report a bug: <a href="https://github.com/apisec-inc/pentest/issues" target="_blank"> https://github.com/apisec-inc/pentest/issues</a></p>');
                        // ga('send', { 'hitType': 'pageview', 'page': '/api-scan-error', 'title': 'Free API Scan Error' });

                    }
                }
            },
            error: function (error) {
                if (error) {
                    $('#email').val("");
                    $('#openAPISpec').val('');
                    $("#Features").removeClass("d-none");
                    $('#btn').prop('disabled', false);
                    $("#testresult").addClass("d-none");
                    $("#loadingresult").addClass("d-none");
                    $("#errorresult").removeClass("d-none");
                    $("#testSearch").removeClass("d-none");
                    // ga('send', { 'hitType': 'pageview', 'page': '/api-scan-error', 'title': 'Free API Scan Error' });
                }
                console.log(error);
            }

        });
        // function verifytestresults() {
        //   if ('#loadingresult') {
        //     $("#testresult").addClass("d-none");
        //   }
        // }
    });
    function tableresults(v) {

        if (v && Object.keys(v).length != 0) {
            $("#tdata").append(
                "<tr>" +
                "<td>" + v.method + ":" + v.path + "</td>" +
                "<td class='severity'>" + v.severity + "</td>" +
                "<td>" + v.cvssScore + "</td>" +
                "<td>" + v.category + "</td>" +
                "<td>" + v.rank + "</td>" +
                "</tr>");
            $("td:contains('Medium')").addClass('yellow');
            $("td:contains('ratelimit_unauthenticated')").text('Ratelimit');
        }
        else {
            $("#statement").text("Hurray! No vulnerabilities found");
        }
    }
    function falsepositvite(j) {

        if (j && Object.keys(j).length != 0) {
            $("#fp").append(
                "<tr>" +
                "<td>" + j.method + ":" + j.endpoint + "</td>" +
                "<td class='severity'>" + j.severity + "</td>" +
                "<td>" + j.category + "</td>" +
                "<td>" + j.rank + "</td>" +
                "<td>" + j.errorResultStatus + "</td>" + "" +
                "</tr>");
            $("td:contains('FALSE_POSITIVE')").text('Marked as False-Positive by AI Bot, review required');

        }
        else {
            $("#statement").text("No data to show");
        }
    }

});